<html>
    <head>
		<title> </title>
		
		<script src="https://pagecdn.io/lib/mathjs/11.0.1/math.js" crossorigin="anonymous"  ></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
	</head>
    <body>
		<script src="structure.js"></script>
		<script src="structureView.js"></script>
		<script src="node.js"></script>
		<script src="member.js"></script>
		<script src="support.js"></script>
		<script src="dof.js"></script>
		<script src="nodalLoad.js"></script>
		<script src="globalLoad.js"></script>
		
        <div>
		
			
			<label> Number of Spans </label>
			<input id="numSpans" type="number" min="1" max="5" value="1" onclick="updateNumberOfSpans()"></input>
			
			<div id="span1Div">
				<label> Span 1 </label>
				<input id="span1" type="number" min="0" value="100" oninput="updateSpanLengths()"></input>
			</div>
			
			<div id="span2Div" style="display:none">
				<label> Span 2 </label>
				<input id="span2" type="number" min="0" value="0" oninput="updateSpanLengths()"></input>
			</div>
			
			<div id="span3Div" style="display:none">
				<label> Span 3 </label>
				<input id="span3" type="number" min="0" value="0" oninput="updateSpanLengths()"></input>
			</div>
			
			<div id="span4Div" style="display:none">
				<label> Span 4 </label>
				<input id="span4" type="number" min="0" value="0" oninput="updateSpanLengths()"></input>
			</div>
			
			<div id="span5Div" style="display:none">
				<label> Span 5 </label>
				<input id="span5" type="number" min="0" value="0" oninput="updateSpanLengths()"></input>
			</div>
			
		</div>
		
		<div>
			<button onclick="runHL93()"> run HL93 </button>
		</div>
		
		<div>
			
			<canvas id="canvas" width="1000" height="400"></canvas>
			<canvas id="deflectionChart" ></canvas>
			<canvas id="momentChart" ></canvas>
			<canvas id="shearChart" ></canvas>
			
        </div>
		
		
		<script>
		
		
			<!-- Initial Structure -->
			let structure = new Structure();
			structure.constructStructureFromSpans([100]);
			
			let load = new GlobalLoad(50, -1);
			structure.addGlobalLoad(load);
				
			structure.solve();
			
			let canvas = document.getElementById("canvas");
			let context = canvas.getContext("2d"); 
			context.translate(25, 80);
			
			let structureView = new StructureView(context, structure);
			
			
			
			<!-- UI Functions -->
			
			function updateNumberOfSpans() {
				let numSpans = parseInt(document.getElementById("numSpans").value);
				if (structureView.spanCounter === 5 && numSpans === 5) {alert("Max number of spans allowed is 5")};
				structureView.spanCounter = numSpans;
				
				for (let i = 1; i <= 5; i++) {
					let element = document.getElementById(`span${i}Div`);
					
					if (i <= numSpans) {
						element.style.display = "block";
					} else {
						document.getElementById(`span${i}`).value = 0;
						element.style.display = "none";
					}
				}
				
				updateSpanLengths();
			}
			
			function updateSpanLengths() {
				let spanArray = [];
				
				for (let i = 1; i <= 5; i++) {
					let spanLength = parseInt(document.getElementById(`span${i}`).value);
					if (spanLength > 0) { spanArray.push(spanLength) };
				}
				
				structure.constructStructureFromSpans(spanArray);
				structureView.redraw();
				// TODO - update charts
			}

			
			
			
			
			
			<!-- Initial Charts Coords.. all will be 0 -->
			
			let momentCoordinates = [];
			let shearCoordinates = [];
			let deflectionCoordinates = [];
			structure.members.forEach( (member, idx) => {
				momentCoordinates.push({x: member.nearNode.coord, y: -1 * member.beginMoment});
				momentCoordinates.push({x: member.farNode.coord, y: member.endMoment});
				shearCoordinates.push({x: member.nearNode.coord, y: member.beginShear});
				shearCoordinates.push({x: member.farNode.coord, y: -1 * member.endShear});
				deflectionCoordinates.push({x: member.nearNode.coord, y: member.nearNode.yDOF.displacement});
				deflectionCoordinates.push({x: member.farNode.coord, y: member.farNode.yDOF.displacement});
			});
			
			let yMinDeflection = -1;  // variables used later on for chart updating
			let yMaxDeflection = 1;
			let yMinMoment = -1;
			let yMaxMoment = 1;
			let yMinShear = -1;
			let yMaxShear = 1;
			
			<!-- Deflection Chart -->
			
			const deflectionData = {
				datasets: [{
					label: 'Deflection',
					data: deflectionCoordinates, 
					backgroundColor: 'rgb(255,99, 132)',
					showLine: true
				}]
			};
			
			const deflectionConfig = {
				type: 'scatter',
				data: deflectionData,
				options: {
					scales: {
						x: {type: 'linear', position: 'bottom'}
					},
					animation: false
				}
			};
			
			const deflectionChart = new Chart(
				document.getElementById('deflectionChart'),
				deflectionConfig
			);
			
			<!-- Moment Chart -->
			
			const momentData = {
				datasets: [{
					label: 'Moment',
					data: momentCoordinates, 
					backgroundColor: 'rgb(0, 206, 209)',
					showLine: true
				}]
			};
			
			const momentConfig = {
				type: 'scatter',
				data: momentData,
				options: {
					scales: {
						x: {type: 'linear', position: 'bottom'}
					},
					animation: false
				}
			};
			
			const momentChart = new Chart(
				document.getElementById('momentChart'),
				momentConfig
			);
			
			
			<!-- Shear Chart -->
			
			const shearData = {
				datasets: [{
					label: 'Shear',
					data: shearCoordinates, 
					backgroundColor: 'rgb(255,99, 132)',
					showLine: true
				}]
			};
			
			const shearConfig = {
				type: 'scatter',
				data: shearData,
				options: {
					scales: {
						x: {type: 'linear', position: 'bottom'}
					},
					animation: false
				}
			};
			
			const shearChart = new Chart(
				document.getElementById('shearChart'),
				shearConfig
			);
			
			<!-- Chart Functions -->
			
			function updateCharts() {
				
				let coord_array_idx = 0;
				structure.members.forEach (member => {
					deflectionCoordinates[coord_array_idx] = {x: member.nearNode.coord, y: member.nearNode.yDOF.displacement};
					deflectionCoordinates[coord_array_idx + 1] = {x: member.farNode.coord, y: member.farNode.yDOF.displacement};
					if (member.farNode.yDOF.displacement < yMinDeflection) {yMinDeflection = member.farNode.yDOF.displacement};
					if (member.farNode.yDOF.displacement > yMaxDeflection) {yMaxDeflection = member.farNode.yDOF.displacement};
					deflectionChart.options.scales.y = {min: yMinDeflection, max: yMaxDeflection};
					
					momentCoordinates[coord_array_idx] = {x: member.nearNode.coord, y: -1 * member.beginMoment};
					momentCoordinates[coord_array_idx + 1] = {x: member.farNode.coord, y: member.endMoment};
					if (member.endMoment > yMaxMoment) {yMaxMoment = member.endMoment};
					if (member.endMoment < yMinMoment) {yMinMoment = member.endMoment};
					momentChart.options.scales.y = {min: yMinMoment, max: yMaxMoment};
					
					shearCoordinates[coord_array_idx] = {x: member.nearNode.coord, y: -1 * member.beginShear};
					shearCoordinates[coord_array_idx + 1] = {x: member.farNode.coord, y: member.endShear};
					if (member.endShear > yMaxShear) {yMaxShear = member.endShear;}
					if (member.endShear < yMinShear) {yMinShear = member.endShear;}
					shearChart.options.scales.y = {min: yMinShear, max: yMaxShear};
					
					coord_array_idx += 2;
				});
				
				deflectionChart.update();
				momentChart.update();
				shearChart.update();
			}
			
			function resetCharts() {
				//TODO
			}
			
			
			<!-- Moving Loads -->
			
			function runHL93() {
				structure.removeAllLoads();
				
				let axle1 = new GlobalLoad(0, -8);
				let axle2 = new GlobalLoad(-14, -32);
				let axle3 = new GlobalLoad(-28, -32);
				[axle1, axle2, axle3].forEach(axle => structure.addGlobalLoad(axle));
				
				let stepDistance = 2;
				let rearAxleInterval = 8;  // can be adjusted but 4 is a good interval for the rear spacing
				
				let hl93Interval = setInterval(function () {
					
					if (axle2.coord - axle3.coord < 30 && axle3.coord > 0) {
						axle3.setCoord(axle3.coord - rearAxleInterval);
					} else {
						axle3.setCoord(axle2.coord - 14);
						structure.stepLoads(stepDistance);
					}
					
					structure.solve();
					structureView.redraw();
					updateCharts();
					
					if (axle3.coord > structure.length) {stopHL93Interval()};
					
				},100);
				
				function stopHL93Interval() {
					clearInterval(hl93Interval);
				}
			}
			
			
			
			
		</script>
    </body>
</html>